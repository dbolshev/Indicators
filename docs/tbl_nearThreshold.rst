.. _tbl_nearThreshold:

=================
tbl_nearThreshold
=================

************************
Суть аналітичної таблиці
************************

Дана аналітична таблиця відображає, які суми закупок у поточному році робив замовник по різним кодам CPV.


*************************
Форма аналітичної таблиці
*************************

Аналітична таблиця містить наступну інформацію:

- Ідентифікатор замовника

Приклад того, як може виглядати аналітична таблиця:

========== ==== =====
Замовник   CPV  Сума
---------- ---- -----
Замовник 1 CPV1 Сума1
Замовник 1 CPV2 Сума2
Замовник 1 CPV3 Сума3
Замовник 2 CPV4 Сума4
Замовник 2 CPV1 Сума5
...        ...  ...
========== ==== =====

******************************
Розрахунок аналітичної таблиці
******************************

Джерела даних для розрахунку
============================

Для розрахунку аналітичної таблиці вікористовуються наступні джерела даних:

- API модуля тендеринга електронної системи закупівель

- Визначення *товарів*, *послуг* чи *робіт* на основі транзакційної змінної :ref:`tv_subjectOfProcurement` та :ref:`порядку визначення категоріі закупівлі за кодом Єдиного закупівельного словника<gsw_formula>`.

- `API курсу валют Національного Банку України <https://bank.gov.ua/control/uk/publish/article?art_id=38441973#exchange>`_


Частота розрахунку
==================

Аналітична таблиця розраховується раз на добу.

Поля для розрахунку
===================

Для розрахунку використовуються наступні поля з API модуля тендеринга:

- ``data.tenderID``

- ``data.procurementMethodType``

- ``data.status``

- ``data.value.amount``

- ``data.value.currency``

- ``data.tenderPeriod.startDate``

- ``data.date``

- ``data.procuringEntity.identifier.scheme``

- ``data.procuringEntity.identifier.id``

Для розрахунку індикатора використовуються наступні транзакційні змінні:

- :ref:`tv_subjectOfProcurement`

Для розрахунку індикатора використовуються наступні поля з API курсу валют Національного Банку України:

- ``cc``

- ``rate``

- ``exchangedate``

Формула розрахунку
==================

1. Перед розрахунком аналітична таблиця очищується.

2. Визначаємо рік створення процедури. Вибираємо 4 символи, починаючи з 4-го з поля ``data.tenderID``.

3. До уваги беремо процедури, що оголошені лише в поточному році.

4. До уваги беруться усі процедури, у яких ``data.procurementMethodType`` мають бути ``belowThreshold``, ``reporting``. Процедури повинні бути завершені, тобто ``data.status = 'complete'``. 

5. Визначається дата створення тендера шляхом перетворення в дату 10 символів починаючи з 4-го з ``data.tenderID``. Нехай це буде "Дата оголошення"

6. До уваги беремо процедури, що оголошені у поточному році. 

7. Для ``data.procurementMethodType = 'reporting'`` ``data.date`` має бути ранішою на 3 дні від дати розрахунку.

8. Знаходиться ідентифікатор замовника - конкатенація ``data.procuringEntity.identifier.scheme`` та ``data.procuringEntity.identifier.id``. Знаходиться очікувана вартість процедури ``data.value.amount``.

9. Перевіряється валюта, в якій вказана очікувана вартість процедури відповідно до поля ``data.value.currency``

  9.а) Якщо очікувана вартість указана в гривнях, тобто ``data.value.currency = 'UAH'``, то вона залишається без змін.

  9.б) Якщо очікувана вартість указана не в гривнях, то вона переводиться у гривні відповідно до курсу даної валюти до гривні за допомогою API курсу валют на "Дату оголошення".

10. Групуємо дані по ідентифікатору замовника та коду CPV сумуючи очікувані вартості процедур. Результат заносимо в таблицю.
  
