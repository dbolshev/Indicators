=======================================================================================================================================================
RISK2-5_1П. Повторна закупівля у одного Постачальника близька до порогу визначенного Законом ('belowThreshold', товари/послуги, 5% нижче 200К)
=======================================================================================================================================================

***************
Суть індикатора
***************

Даний індикатор виявляє ситуації, Замовник проводить не першу допорогову закупівлю у одного постачальника товарів чи послуг з сумою, що дуже близька до порогу 200000 грн. (або 1000000 грн.). Індикатор спрацьовує, якщо протягом календарного року Замовник вже проводив закупівлі, що близькі до порогу. Тобто маємо високу вірогідність навмисного уникання проведення відкритих торгів.

********************************
Підстава для розробки індикатора
********************************

Цей індикатор було розроблено, щоб виявляти спроби Замовників уникати процедур відкритих торгів.

*********************************
Методологія розрахунку індикатора
*********************************

Рівень розрахунку
=================
Індикатор розраховується на рівні *тердера*.

Джерела даних для розрахунку
============================

Для розрахунку індикатора вікористовуються наступні джерела даних:

- API модуля тендеринга електронної системи закупівель

- Аналітична таблиця tbl_nearThresholdOneSupplier

- `API курсу валют Національного Банку України <https://bank.gov.ua/control/uk/publish/article?art_id=38441973#exchange>`_

- Транзакційна змінна :ref:`tv_subjectOfProcurement`


Типи процедур
=============

Індикатор розраховується для наступних типів процедур:

- ``belowThreshold`` - *допорогові закупівлі*


Типи замовників
===============

Індикатор розраховується для загальних замовників (``general``) та замовників, що здійснюють діяльність в окремих сферах господарювання (``special``).


Категорії товарів
=================

Індикатор розраховується для процедур закупівлі *товарів*, *послуг* відподівно до транзакційної змінної :ref:`tv_subjectOfProcurement` та :ref:`порядку визначення категоріі закупівлі за кодом Єдиного закупівельного словника<gsw_formula>`.

Індикатор не розраховується для процедур які підпадають під дію норми закону Стаття 2. частина 3, пункт: . Дія цього Закону не поширюється на випадки, якщо предметом закупівлі є: - послуги фінансових установ, у тому числі міжнародних фінансових організацій, щодо надання кредитів, гарантій, фінансового лізингу та послуги, допоміжні до фінансових послуг.

З розрахунку необхідно виключити процедури в який код CPV 6611 та в назві процедури title присутні буквосполучення кредит, гарант та лізинг

Стадії процедур
===============

Подія, що вмикає розрахунок індикатора
--------------------------------------
Подія, що вмикає розрахунок індикатора - перехід процедури у статус ``active.qualification``.


Подія, що вимикає розрахунок індикатора
---------------------------------------
Pозрахунок індикатора вимикається тоді, процедура пореходить в статус ``complete``.

Статуси процедур
----------------

Виходячи з подій, що вмикають та вимикають розрахунок індикатора, маємо наступні умови розрахунку:

- Індикатор розраховується для наступних статусів процедур:
   
  - ``active.qualification`` 
  
  - ``active.awarded``



Частота розрахунку
==================

Індикатор розраховується при будь-якій зміні json-документа, що відповідає процедурі, якщо присутні всі умови для його розрахунку.

Окрім цього індикатор перераховується раз на добу незалежно від змін у json-документі, що відповідає процедурі, якщо присутні всі умови для його розрахунку.

Для розрахунку індикатора використовуються наступні поля з API модуля тендеринга:

- ``data.value``

- ``data.value.amount``

- ``data.value.currency``

- ``data.tenderPeriod.startDate``

- ``data.procuringEntity.identifier.scheme``

- ``data.procuringEntity.identifier.scheme``

- ``data.awards.status``

- ``data.awards.suppliers.identifier.scheme``

- ``data.awards.suppliers.identifier.id``

Для розрахунку індикатора використовуються наступні транзакційні змінні:

:ref:`tv_subjectOfProcurement`

Для розрахунку індикатора використовуються наступні поля з API курсу валют Національного Банку України:

- ``cc``

- ``rate``

- ``exchangedate``


Формула розрахунку
==================

1. Якщо в json-документі, що відповідає процедурі, відсутній блок ``data.contracts``, де хоча б в одного об'єкту виконується ``data.contracts.status = 'pending'``, індикатор дорівнює ``-2``. Розрахунок завершується.

2. Якщо в json-документі, що відповідає процедурі, присутній блок ``data.contracts``, де хоча б в одного об'єкту виконується ``data.contracts.status = 'pending'``, переходимо на наступний крок.

3. Знаходимо переможця процедури (конкатенація ``data.awards.suppliers.identifier.scheme`` та ``data.awards.suppliers.identifier.id``) з об'єкту, де ``data.awards.status='active'``

4. Перевіряється валюта, в якій вказана очікувана вартість процедури відповідно до поля data.value.currency.

   4.а) Якщо очікувана вартість указана в гривнях, тобто data.value.currency = 'UAH', то вона залишається без змін.

   4.б) Якщо очікувана вартість указана не в гривнях, то вона переводиться у гривні відповідно до курсу даної валюти до гривні за допомогою API курсу валют на дату data.tenderPeriod.startDate

5. Якщо закупівлю проводить загальний замовник (general)

   5.а) Якщо очікувана вартість в гривнях перевищує 190000 (сто дев'яносто тисяч) і менше 200000 (двісті тисяч) та в аналітичній таблиці є запис для поточного замовника (конкатенація ``data.procuringEntity.identifier.scheme`` та ``data.procuringEntity.identifier.id`` і  конкатенація ``data.awards.suppliers.identifier.scheme`` та ``data.awards.suppliers.identifier.id``) то індикатор приймає значення "1".

   5.б) В інакшому випадку індикатор приймає значення 0

6. Якщо закупівлю проводить замовник, що здійснює діяльність в окремих сферах господарювання (special)

   6.а) Якщо очікувана вартість в гривнях перевищує 950000 (дев'ятьсот п'ятдесят тисяч) і менше 1000000 (один мільйон) та в аналітичній таблиці є запис для поточного замовника (конкатенація ``data.procuringEntity.identifier.scheme`` та ``data.procuringEntity.identifier.id`` і  конкатенація ``data.awards.suppliers.identifier.scheme`` та ``data.awards.suppliers.identifier.id``), то індикатор приймає значення "1".

   6.б) В інакшому випадку індикатор приймає значення 0

Фактори, що впливають на неточність розрахунку
==============================================

Індикатор може бути порахований неточно у випадках, коли організації, що не є замовниками, помилково визначають себе в системі як замовники.

