.. _tbl_belowThresholdForCPV4:

=========================
tbl_belowThresholdForCPV4
=========================

************************
Суть аналітичної таблиці
************************

Дана аналітична таблиця відображає суму допорогових закупівель по групі кодів CPV4, що проводив Замовник протягом поточного року.

*************************
Форма аналітичної таблиці
*************************

Аналітична таблиця містить наступну інформацію:

- Ідентифікатор замовника

- Ідентифікатор групи товарів CPV4

- Суму закупівель по ідентифікатору CPV4

Приклад того, як може виглядати аналітична таблиця:

========== ====== ======
Замовник   CPV4   Сума
---------- ------ ------
Замовник 1 cpv4 1 сума 1
Замовник 1 cpv4 2 сума 2
Замовник 1 cpv4 3 сума 3
Замовник 2 cpv4 4 сума 4
Замовник 2 cpv4 5 сума 5
...        ...    ...
========== ====== ======

******************************
Розрахунок аналітичної таблиці
******************************

Джерела даних для розрахунку
============================

Для розрахунку аналітичної таблиці вікористовуються наступні джерела даних:

- API модуля тендеринга електронної системи закупівель

- Визначення *товарів*, *послуг* чи *робіт* на основі транзакційної змінної :ref:`tv_subjectOfProcurement` та :ref:`порядку визначення категоріі закупівлі за кодом Єдиного закупівельного словника<gsw_formula>`.

- `API курсу валют Національного Банку України <https://bank.gov.ua/control/uk/publish/article?art_id=38441973#exchange>`_


Частота розрахунку
==================

Аналітична таблиця розраховується раз на добу.

Поля для розрахунку
===================

Для розрахунку використовуються наступні поля з API модуля тендеринга:

- ``data.procuringEntity.identifier.id``

- ``data.procurementMethodType``

- ``data.status``

- ``data.tenderID``

- ``data.value``

- ``data.value.amount``

- ``data.value.currency``

- ``data.tenderPeriod.startDate``

Для розрахунку індикатора використовуються наступні транзакційні змінні:

- :ref:`tv_subjectOfProcurement`

Для розрахунку індикатора використовуються наступні поля з API курсу валют Національного Банку України:

- ``cc``

- ``rate``

- ``exchangedate``

Формула розрахунку
==================

1. Перед розрахунком аналітична таблиця очищується.

2. До уваги беруться усі процедури, у яких ``data.procurementMethodType`` мають бути ``belowThreshold``, ``reporting``. Процедури повинні бути завершені, тобто ``data.status = 'complete'``

3. Для кожної процедури знаходимо її cpv код data.items.classification.id. Знаходимо cpv4 для кожного cpv - беремо перші 4 цифри від cpv та додаємо до них "0000".

4. Не беремо до уваги ті процедури, у яких cpv починається з "65".

5. Визначаємо дату створення тендера шляхом перетворення в дату 10 символів починаючи з 4-го з ``data.tenderID``. Нехай це буде "Дата оголошення"

6. До уваги беремо процедури, що оголошені у поточному році.

7. Визначаємо Замовника для кожної процедури - ``data.procuringEntity.identifier.id``.

8. Перевіряємо валюту, в якій вказана очікувана вартість процедури відповідно до поля ``data.value.currency``

  8.а) Якщо очікувана вартість указана в гривнях, тобто ``data.value.currency = 'UAH'``, то вона залишається без змін.

  8.б) Якщо очікувана вартість указана не в гривнях, то вона переводиться у гривні відповідно до курсу даної валюти до гривні за допомогою API курсу валют на "Дату оголошення".

9. Проводимо групування по полю Замовника та cpv4, сумуючи всі очікувані вартості *в гривнях*.

